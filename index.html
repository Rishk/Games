<!DOCTYPE html>
<html>

<head>
  <title>Higher or Lower</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" type="text/css" href="css/cards.css" />
  <link rel="stylesheet" type="text/css" href="css/main.css" />

  <link href="https://fonts.googleapis.com/css2?family=Arbutus+Slab&display=swap"
    rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
</head>

<body>
  <div id="app">
    <div align="center">
      <h1>Higher or Lower &#x1F0CF;</h1>
      <h2 v-html="subtitle()"></h2>
      <div id="controlButtons">
        <button v-on:click="play(true)" :disabled="gameOver">Higher</button>
        <button v-on:click="play(false)" :disabled="gameOver">Lower</button>
        <button v-on:click="reset()">Reset</button>
      </div>
      <div v-for="player in players" class="playingCards simpleCards">
        <p class="playerName">{{ player.name }}</P>
        <div v-for="card in player.cards" class="card" :class="card.getClass()">
          <span class="rank">{{ card.rank.toUpperCase() }}</span>
          <span class="suit" v-html="card.symbol()"></span>
        </div>
        <div v-for="_ in cardsRemaining(player)" class="card back">*</div>
      </div>
    </div>
    <div id="rules">
      <p>Rules:
        <ul>
          <li>The rank ordering is:
            {{ ranks.map(r => r.toUpperCase()).join(", ") }}.</li>
          <li>If the rank is the same, the guess is incorrect.</li>
          <li>To win, a player must correctly guess the last
            card.</li>
          <li>If you are the last player, you must guess every remaining
            card correctly to win.</li>
        </ul>
      </p>
    </div>
  </div>

  <script>
    function Card(suit, rank) {
      this.suit = suit;
      this.rank = rank;
      this.symbol = () => {
        return `&${suit};`;
      }
      this.getClass = () => {
        return `rank-${this.rank} ${this.suit}`;
      }
    }

    var app = new Vue({
      el: '#app',
      data: {
        numCards: 6,
        ranks: ['a', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'j', 'q',
          'k'
        ],
        suits: ['diams', 'hearts', 'spades', 'clubs'],
        deck: [],
        players: [{
          name: 'Player 1',
          cards: []
        }, {
          name: 'Player 2',
          cards: []
        }],
        currPlayer: null,
        gameOver: false,
        winner: null,
      },
      created() {
        this.reset();
      },
      methods: {
        randomIndex(length) {
          return Math.floor(Math.random() * length);
        },
        randomCard() {
          return this.deck.splice(this.randomIndex(this.deck.length), 1)[0];
        },
        resetDecks() {
          let numDecks = Math.ceil(this.numCards * this.players.length / 52);

          this.deck = [];
          while (numDecks > 0) {
            this.suits.forEach(suit => {
              this.ranks.forEach(rank => {
                this.deck.push(new Card(suit, rank));
              });
            });
            numDecks--;
          }
        },
        reset() {
          this.resetDecks();
          this.players.forEach(player => {
            Vue.set(player, 'cards', [this.randomCard()]);
          });
          this.currPlayer = this.randomIndex(this.players.length);
          this.gameOver = false;
        },
        cardsRemaining(player) {
          return this.numCards - player.cards.length;
        },
        nextPlayer() {
          /* Return the index of the next player that has unrevealed cards,
             return null if there are no other players with unrevealed cards. */
          let nextPlayer = this.currPlayer;
          do {
            nextPlayer = (nextPlayer + 1) % this.players.length;
          } while (nextPlayer != this.currPlayer &&
            this.players[nextPlayer].cards.length == this.numCards);
          return nextPlayer == this.currPlayer ? null : nextPlayer;
        },
        correctGuess(rank1, rank2, guessedHigher) {
          if (rank1 == rank2) {
            return false;
          }
          let higher = this.ranks.indexOf(rank2) > this.ranks.indexOf(rank1);
          return higher === guessedHigher;
        },
        play(guessedHigher) {
          let currCards = this.players[this.currPlayer].cards;
          let currCard = currCards[currCards.length - 1];

          // Select the next card.
          let nextCard = this.randomCard();
          currCards.push(nextCard);

          // Check whether the guess was correct.
          let correct = this.correctGuess(currCard.rank, nextCard.rank,
            guessedHigher);

          if (!correct) {
            let nextPlayer = this.nextPlayer();
            if (nextPlayer == null) {
              // Every player has lost.
              this.gameOver = true;
              this.winner = null;
            } else {
              // Move to the next player.
              this.currPlayer = nextPlayer;
            }
            return;
          }

          if (currCards.length == this.numCards) {
            // Player has correctly guessed the final card.
            this.gameOver = true;
            this.winner = this.players[this.currPlayer];
            return;
          }

          // Player correctly guessed the card, so can play again.
        },
        subtitle() {
          let player = this.players[this.currPlayer];
          if (!this.gameOver) {
            return `Current Player: <u>${player.name}</u>`;
          }

          if (this.winner == null) {
            return "Game over... Both players lost &#x1F622;";
          }

          return `Game over... <u>${this.winner.name}</u> wins! &#x1F3C6;`;
        }
      }
    });
  </script>
</body>

</html>